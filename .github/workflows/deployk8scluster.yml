name: Setup Kubernetes Cluster

on:
  workflow_dispatch:  # Ручной запуск через интерфейс GitHub

jobs:
  setup-cluster:
    runs-on: ubuntu-latest

    steps:
    - name: Install Prerequisites
      run: sudo apt-get update && sudo apt-get install -y python3-pip python3-venv sshpass

    - name: Setup SSH Agent
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Connect to Server and Setup Cluster
      run: |
        ssh -o StrictHostKeyChecking=no -p 55522 k8s@93.85.93.70 << 'EOF'
          # Настройка Virtual Environment для Python
          python3 -m venv ~/envs/kubespray
          source ~/envs/kubespray/bin/activate

          # Установка Ansible в виртуальном окружении
          pip install ansible==5.2.0 jinja2 netaddr

          # Клонирование репозитория Kubespray
          rm -rf ~/testcluster  # Удаление существующего каталога, если такой есть
          git clone https://github.com/kubernetes-sigs/kubespray.git ~/testcluster
          cd ~/testcluster

          if [ -d "inventory/sample" ]; then
            cp -rfp inventory/sample inventory/mycluster
          fi

          declare -a IPS=(10.10.35.61 10.10.35.63)
          CONFIG_FILE=inventory/mycluster/hosts.yaml python3 contrib/inventory_builder/inventory.py ${IPS[@]}

          # Обновление Ansible инвентаря для использования пользователя 'it'
          if [ -f "inventory/mycluster/hosts.yaml" ]; then
            sed -i 's/ansible_user: root/ansible_user: it/g' inventory/mycluster/hosts.yaml
            ansible-playbook -i inventory/mycluster/hosts.yaml --become --become-user=root cluster.yml
          fi
          deactivate
        EOF

    - name: Clean up
      run: echo "Kubernetes cluster setup completed."
